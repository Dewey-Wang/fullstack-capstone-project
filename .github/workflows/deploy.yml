name: Deploy Full Stack App

on:
  push:
    branches:
      - main  # 觸發條件：當推送到 main 分支時部署

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout 代碼
      uses: actions/checkout@v3

    - name: 登入 Docker Hub
      run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

    - name: 構建並推送後端 Docker 映像
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/giftapp-backend:latest ./giftlink-backend
        docker push ${{ secrets.DOCKER_USERNAME }}/giftapp-backend:latest

    - name: 構建並推送前端 Docker 映像
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/giftapp-frontend:latest ./giftlink-frontend
        docker push ${{ secrets.DOCKER_USERNAME }}/giftapp-frontend:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
    - name: SSH 連線到伺服器並部署
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          docker pull ${{ secrets.DOCKER_USERNAME }}/giftapp-backend:latest
          docker pull ${{ secrets.DOCKER_USERNAME }}/giftapp-frontend:latest
          docker-compose up -d
